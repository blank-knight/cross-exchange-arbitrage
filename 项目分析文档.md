# 跨交易所套利机器人项目分析文档

## 1. 项目概述

该项目是一个基于Python实现的跨交易所加密货币套利机器人，主要用于在EdgeX和Lighter两个交易所之间进行期货套利交易。通过利用两个交易所之间的价格差异，机器人能够自动识别套利机会并执行交易操作，从而获取稳定的收益。

项目采用异步编程模型（asyncio）实现高性能的实时数据处理和交易执行，使用WebSocket技术获取实时市场数据和订单状态更新，并通过抽象基类（ABC）统一不同交易所的客户端接口。

## 2. 目录结构

```
cross-exchange-arbitrage/
├── arbitrage.py              # 主程序入口点
├── exchanges/                # 交易所客户端实现
│   ├── base.py              # 抽象基类定义
│   ├── edgex.py             # EdgeX交易所客户端
│   ├── lighter.py           # Lighter交易所客户端
│   └── lighter_custom_websocket.py  # Lighter自定义WebSocket客户端
├── strategy/                 # 策略核心模块
│   ├── data_logger.py       # 数据记录器
│   ├── edgex_arb.py         # 套利策略核心实现
│   ├── order_book_manager.py # 订单簿管理器
│   ├── order_manager.py     # 订单管理器
│   ├── position_tracker.py  # 仓位跟踪器
│   └── websocket_manager.py # WebSocket连接管理器
├── .env.example             # 环境变量示例
└── requirements.txt         # 项目依赖
```

## 3. 核心模块分析

### 3.1 主程序入口（arbitrage.py）

**功能**：项目的主程序入口点，负责解析命令行参数、初始化套利机器人并启动交易循环。

**关键函数**：
- `parse_arguments()`: 解析命令行参数，包括交易对、订单数量、填充超时、最大仓位、套利阈值等
- `validate_exchange()`: 验证指定的交易所是否有效
- `main()`: 主函数，负责初始化环境变量、验证交易所、创建并运行EdgexArb机器人实例

**使用示例**：
```bash
python arbitrage.py -t BTC -s 0.01 -f 5 -m 0.1 -l 10 -sh 10
```

### 3.2 交易所客户端（exchanges/）

#### 3.2.1 抽象基类（base.py）

**功能**：定义交易所客户端的抽象基类，统一不同交易所的接口规范。

**关键类与方法**：
- `BaseExchangeClient`（ABC）: 交易所客户端抽象基类
  - `place_open_order()`: 下开仓订单
  - `cancel_order()`: 取消订单
  - `get_account_positions()`: 获取账户仓位
  - `get_order_book()`: 获取订单簿数据

- `OrderResult`（dataclass）: 订单结果数据类
  - `order_id`: 订单ID
  - `status`: 订单状态
  - `price`: 订单价格
  - `quantity`: 订单数量

- `OrderInfo`（dataclass）: 订单信息数据类
  - `order_id`: 订单ID
  - `client_order_id`: 客户端订单ID
  - `price`: 订单价格
  - `quantity`: 订单数量
  - `filled_quantity`: 已成交数量
  - `status`: 订单状态

- `query_retry()`: 重试装饰器，用于网络请求失败时的自动重试

#### 3.2.2 EdgeX交易所客户端（edgex.py）

**功能**：实现EdgeX交易所的客户端功能，包括WebSocket连接、订单操作和仓位管理。

**关键类与方法**：
- `EdgexClient`（继承BaseExchangeClient）: EdgeX交易所客户端
  - `place_open_order()`: 下开仓订单（支持post-only模式）
  - `cancel_order()`: 取消订单
  - `get_account_positions()`: 获取账户仓位
  - `fetch_bbo_prices()`: 获取最佳买卖价（BBO）
  - `round_to_tick()`: 将价格四舍五入到最小跳动单位

**特点**：
- 支持WebSocket自动重连
- 实现了post-only限价单策略，避免立即成交
- 包含订单簿深度获取功能

#### 3.2.3 Lighter交易所客户端（lighter.py）

**功能**：实现Lighter交易所的客户端功能，包括市场配置获取、订单操作和仓位管理。

**关键类与方法**：
- `LighterClient`（继承BaseExchangeClient）: Lighter交易所客户端
  - `place_open_order()`: 下开仓订单
  - `cancel_order()`: 取消订单
  - `get_account_positions()`: 获取账户仓位
  - `_fetch_positions_with_retry()`: 带重试机制的仓位获取
  - `_get_market_config()`: 获取市场配置信息

**特点**：
- 支持市场配置自动获取
- 实现了仓位跟踪功能
- 包含请求重试机制

#### 3.2.4 Lighter自定义WebSocket客户端（lighter_custom_websocket.py）

**功能**：Lighter交易所的自定义WebSocket客户端，负责处理实时订单簿更新和订单状态通知。

**关键类与方法**：
- `LighterWebSocketManager`: Lighter WebSocket连接管理器
  - `connect()`: 建立WebSocket连接
  - `update_order_book()`: 更新订单簿数据
  - `on_order_filled()`: 订单成交回调
  - `handle_order_book_update()`: 处理订单簿更新消息
  - `handle_account_order_update()`: 处理账户订单更新消息

**特点**：
- 支持订单簿快照加载和增量更新
- 实现了序列间隙检测和恢复机制
- 支持自动重连和超时处理

### 3.3 策略核心（strategy/）

#### 3.3.1 数据记录器（data_logger.py）

**功能**：负责记录交易数据和市场数据到CSV文件，用于后续分析和审计。

**关键类与方法**：
- `DataLogger`: 数据记录器类
  - `log_trade_to_csv()`: 记录交易数据到CSV
  - `log_bbo_to_csv()`: 记录最佳买卖价数据到CSV
  - `flush_bbo_buffer()`: 刷新BBO数据缓冲区
  - `close()`: 关闭文件句柄

**特点**：
- 支持交易数据和BBO数据的分别记录
- 实现了BBO数据的缓冲写入，优化IO性能
- 自动创建包含必要字段的CSV文件

#### 3.3.2 套利策略核心（edgex_arb.py）

**功能**：套利机器人的核心实现，负责初始化各个模块、配置交易所连接、检测套利机会并执行交易。

**关键类与方法**：
- `EdgexArb`: 套利机器人类
  - `__init__()`: 初始化机器人配置和各个模块
  - `_setup_logger()`: 设置日志记录器
  - `_setup_callbacks()`: 设置回调函数
  - `initialize_lighter_client()`: 初始化Lighter客户端
  - `initialize_edgex_client()`: 初始化EdgeX客户端
  - `get_lighter_market_config()`: 获取Lighter市场配置
  - `get_edgex_contract_info()`: 获取EdgeX合约信息
  - `trading_loop()`: 主交易循环
  - `_execute_long_trade()`: 执行多头套利交易
  - `_execute_short_trade()`: 执行空头套利交易
  - `run()`: 启动套利机器人
  - `shutdown()`: 优雅关闭机器人

**特点**：
- 实现了完整的交易生命周期管理
- 支持多头和空头两种套利模式
- 包含风险控制机制（最大仓位限制、订单填充超时等）

#### 3.3.3 订单簿管理器（order_book_manager.py）

**功能**：管理两个交易所的订单簿状态，提供最新的市场数据。

**关键类与方法**：
- `OrderBookManager`: 订单簿管理器类
  - `update_edgex_order_book()`: 更新EdgeX订单簿
  - `get_edgex_bbo()`: 获取EdgeX最佳买卖价
  - `reset_lighter_order_book()`: 重置Lighter订单簿
  - `update_lighter_order_book()`: 更新Lighter订单簿
  - `validate_order_book_offset()`: 验证订单簿偏移量序列
  - `validate_order_book_integrity()`: 验证订单簿完整性
  - `get_lighter_best_levels()`: 获取Lighter最佳买卖价位
  - `get_lighter_bbo()`: 获取Lighter最佳买卖价
  - `get_lighter_mid_price()`: 计算Lighter中间价
  - `update_lighter_bbo()`: 更新Lighter最佳买卖价

**特点**：
- 支持两个交易所的订单簿独立管理
- 实现了订单簿数据的验证和完整性检查
- 提供多种市场数据查询接口

#### 3.3.4 订单管理器（order_manager.py）

**功能**：负责管理订单的创建、取消和执行状态跟踪。

**关键类与方法**：
- `OrderManager`: 订单管理器类
  - `set_edgex_config()`: 设置EdgeX配置
  - `set_lighter_config()`: 设置Lighter配置
  - `set_callbacks()`: 设置回调函数
  - `round_to_tick()`: 将价格四舍五入到最小跳动单位
  - `fetch_edgex_bbo_prices()`: 获取EdgeX最佳买卖价
  - `place_bbo_order()`: 下BBO订单
  - `place_edgex_post_only_order()`: 下EdgeX post-only订单
  - `handle_edgex_order_update()`: 处理EdgeX订单更新
  - `update_edgex_order_status()`: 更新EdgeX订单状态
  - `place_lighter_market_order()`: 下Lighter市价订单
  - `monitor_lighter_order()`: 监控Lighter订单状态
  - `handle_lighter_order_filled()`: 处理Lighter订单成交

**特点**：
- 支持两个交易所的订单管理
- 实现了订单状态的实时跟踪
- 提供回调机制处理订单事件

#### 3.3.5 仓位跟踪器（position_tracker.py）

**功能**：跟踪和管理两个交易所的仓位状态。

**关键类与方法**：
- `PositionTracker`: 仓位跟踪器类
  - `get_edgex_position()`: 获取EdgeX仓位
  - `get_lighter_position()`: 获取Lighter仓位
  - `update_edgex_position()`: 更新EdgeX仓位
  - `update_lighter_position()`: 更新Lighter仓位
  - `get_current_edgex_position()`: 获取当前EdgeX仓位
  - `get_net_position()`: 计算净仓位

**特点**：
- 支持两个交易所的仓位独立跟踪
- 提供净仓位计算功能
- 实现了仓位更新的实时通知

#### 3.3.6 WebSocket连接管理器（websocket_manager.py）

**功能**：管理两个交易所的WebSocket连接，处理实时数据更新。

**关键类与方法**：
- `WebSocketManagerWrapper`: WebSocket连接管理器类
  - `set_edgex_ws_manager()`: 设置EdgeX WebSocket管理器
  - `set_lighter_config()`: 设置Lighter配置
  - `set_callbacks()`: 设置回调函数
  - `handle_edgex_order_book_update()`: 处理EdgeX订单簿更新
  - `setup_edgex_websocket()`: 设置EdgeX WebSocket连接
  - `request_fresh_snapshot()`: 请求新的订单簿快照
  - `handle_lighter_ws()`: 处理Lighter WebSocket连接
  - `start_lighter_websocket()`: 启动Lighter WebSocket任务
  - `shutdown()`: 关闭WebSocket连接

**特点**：
- 支持两个交易所的WebSocket连接管理
- 实现了订单簿数据的实时更新
- 提供自动重连和错误处理机制

## 4. 依赖关系

项目的主要依赖如下：

| 依赖包 | 版本 | 用途 |
|-------|------|------|
| python-dotenv | >=1.0.0 | 环境变量管理 |
| pytz | >=2025.2 | 时区处理 |
| asyncio | ==4.0.0 | 异步编程框架 |
| requests | ==2.32.5 | HTTP请求 |
| tenacity | >=9.1.2 | 重试机制 |
| edgex-python-sdk | 自定义分支 | EdgeX交易所SDK |
| lighter-python | 自定义分支 | Lighter交易所SDK |

## 5. 整体架构

项目采用模块化设计，各组件之间通过明确的接口进行通信，实现了高度的解耦和可扩展性。整体架构如下：

```
┌─────────────────────────────────────────────────────────────────┐
│                           arbitrage.py                          │
└─────────────┬───────────────────────────────────────────────────┘
              │
┌─────────────▼───────────────────────────────────────────────────┐
│                         strategy/edgex_arb.py                  │
└─────────────┬───────────────────────────────────────────────────┘
              │
┌─────────────▼───────────────────────────────────────────────────┐
│                         策略核心组件                           │
├─────────────┬─────────────┬─────────────┬─────────────┬─────────┤
│ data_logger │ order_book_│ order_manager │ position_   │ websocket_manager │
│             │ manager    │              │ tracker     │         │
└─────────────┴─────────────┴─────────────┴─────────────┴─────────┘
              │
┌─────────────▼───────────────────────────────────────────────────┐
│                         交易所客户端                           │
├─────────────┬───────────────────────────────────────────────────┤
│ edgex.py    │ lighter.py       │ lighter_custom_websocket.py    │
└─────────────┴───────────────────────────────────────────────────┘
              │
┌─────────────▼───────────────────────────────────────────────────┐
│                         抽象基类 (base.py)                      │
└─────────────────────────────────────────────────────────────────┘
```

### 5.1 数据流

1. **市场数据获取**：通过WebSocket连接从两个交易所获取实时订单簿数据
2. **套利机会检测**：分析两个交易所的价格差异，检测是否存在套利机会
3. **订单执行**：当检测到套利机会时，在EdgeX上下post-only订单，在Lighter上下市价订单
4. **仓位管理**：实时跟踪两个交易所的仓位状态，确保不超过最大仓位限制
5. **数据记录**：将交易数据和市场数据记录到CSV文件，用于后续分析

### 5.2 核心流程

1. **初始化阶段**：解析命令行参数，加载环境变量，初始化各个模块
2. **连接建立**：建立与两个交易所的WebSocket连接，获取实时市场数据
3. **仓位同步**：获取并同步两个交易所的初始仓位
4. **交易循环**：
   - 获取最新的市场数据
   - 检测套利机会
   - 执行套利交易
   - 更新仓位状态
   - 记录交易数据
5. **关闭阶段**：关闭WebSocket连接，保存未写入的数据，清理资源

## 6. 风险控制

项目包含多种风险控制机制，确保交易的安全性和稳定性：

1. **最大仓位限制**：通过`max_position`参数限制单个方向的最大仓位
2. **订单填充超时**：通过`fill_timeout`参数限制订单的最大等待时间
3. **套利阈值**：通过`long_threshold`和`short_threshold`参数控制套利机会的触发条件
4. **自动重试机制**：网络请求失败时自动重试，提高系统的稳定性
5. **序列间隙检测**：检测订单簿数据的序列间隙，确保数据的完整性
6. **优雅关闭**：支持信号处理和优雅关闭，确保资源的正确释放

## 7. 总结

该跨交易所套利机器人项目采用模块化设计和异步编程模型，实现了高性能、高可靠性的套利交易功能。通过统一的交易所接口和灵活的策略配置，项目具有良好的可扩展性和可维护性。

项目的核心价值在于能够自动识别和利用交易所之间的价格差异，实现稳定的套利收益，同时通过完善的风险控制机制确保交易的安全性和稳定性。